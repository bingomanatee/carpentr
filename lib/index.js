!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("@wonderlandlabs/looking-glass-engine")):"function"==typeof define&&define.amd?define(["@wonderlandlabs/looking-glass-engine"],t):(e=e||self).LGE=t(e.lookingGlassEngine)}(this,(function(e){"use strict";var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(e,t){return e(t={exports:{}},t.exports),t.exports}var o="object"==typeof t&&t&&t.Object===Object&&t,n="object"==typeof self&&self&&self.Object===Object&&self,a=o||n||Function("return this")(),i=a.Symbol,s=Object.prototype,c=s.hasOwnProperty,u=s.toString,d=i?i.toStringTag:void 0;var f=function(e){var t=c.call(e,d),r=e[d];try{e[d]=void 0;var o=!0}catch(e){}var n=u.call(e);return o&&(t?e[d]=r:delete e[d]),n},l=Object.prototype.toString;var p=function(e){return l.call(e)},y=i?i.toStringTag:void 0;var m=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":y&&y in Object(e)?f(e):p(e)};var h=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)};var b,v=function(e){if(!h(e))return!1;var t=m(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t},g=a["__core-js_shared__"],w=(b=/[^.]+$/.exec(g&&g.keys&&g.keys.IE_PROTO||""))?"Symbol(src)_1."+b:"";var S=function(e){return!!w&&w in e},E=Function.prototype.toString;var O=function(e){if(null!=e){try{return E.call(e)}catch(e){}try{return e+""}catch(e){}}return""},R=/^\[object .+?Constructor\]$/,j=Function.prototype,P=Object.prototype,T=j.toString,_=P.hasOwnProperty,A=RegExp("^"+T.call(_).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var D=function(e){return!(!h(e)||S(e))&&(v(e)?A:R).test(O(e))};var x=function(e,t){return null==e?void 0:e[t]};var F=function(e,t){var r=x(e,t);return D(r)?r:void 0},I=F(a,"Map");F(Object,"create"),function(){try{var e=F(Object,"defineProperty");e({},"",{})}catch(e){}}();var N=function(e){return null!=e&&"object"==typeof e};var q=function(e){return N(e)&&"[object Arguments]"==m(e)},M=Object.prototype,k=M.hasOwnProperty,U=M.propertyIsEnumerable;q(function(){return arguments}());var C=function(){return!1},V=(r((function(e,t){var r=t&&!t.nodeType&&t,o=r&&e&&!e.nodeType&&e,n=o&&o.exports===r?a.Buffer:void 0,i=(n?n.isBuffer:void 0)||C;e.exports=i})),r((function(e,t){var r=t&&!t.nodeType&&t,n=r&&e&&!e.nodeType&&e,a=n&&n.exports===r&&o.process,i=function(){try{var e=n&&n.require&&n.require("util").types;return e||a&&a.binding&&a.binding("util")}catch(e){}}();e.exports=i}))),z=(V&&V.isTypedArray,r((function(e,t){var r=t&&!t.nodeType&&t,o=r&&e&&!e.nodeType&&e,n=o&&o.exports===r?a.Buffer:void 0,i=n?n.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var r=e.length,o=i?i(r):new e.constructor(r);return e.copy(o),o}})),F(a,"DataView")),W=F(a,"Promise"),$=F(a,"Set"),G=F(a,"WeakMap"),K=O(z),L=O(I),Q=O(W),B=O($),H=O(G),J=m;(z&&"[object DataView]"!=J(new z(new ArrayBuffer(1)))||I&&"[object Map]"!=J(new I)||W&&"[object Promise]"!=J(W.resolve())||$&&"[object Set]"!=J(new $)||G&&"[object WeakMap]"!=J(new G))&&(J=function(e){var t=m(e),r="[object Object]"==t?e.constructor:void 0,o=r?O(r):"";if(o)switch(o){case K:return"[object DataView]";case L:return"[object Map]";case Q:return"[object Promise]";case B:return"[object Set]";case H:return"[object WeakMap]"}return t});a.Uint8Array;var X=i?i.prototype:void 0;X&&X.valueOf,V&&V.isMap,V&&V.isSet;function Y(e){for(var t=arguments.length,r=Array(t>1?t-1:0),o=1;o<t;o++)r[o-1]=arguments[o];if("production"!==process.env.NODE_ENV){var n=Ce[e],a=n?"function"==typeof n?n.apply(null,r):n:"unknown error nr: "+e;throw Error("[Immer] "+a)}throw Error("[Immer] minified error nr: "+e+(r.length?" "+r.map((function(e){return"'"+e+"'"})).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function Z(e){return!!e&&!!e[Ue]}function ee(e){return!!e&&(function(e){if(!e||"object"!=typeof e)return!1;var t=Object.getPrototypeOf(e);if(null===t)return!0;var r=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return"function"==typeof r&&Function.toString.call(r)===Ve}(e)||Array.isArray(e)||!!e[ke]||!!e.constructor[ke]||ae(e)||ie(e))}function te(e,t,r){void 0===r&&(r=!1),0===re(e)?(r?Object.keys:ze)(e).forEach((function(o){r&&"symbol"==typeof o||t(o,e[o],e)})):e.forEach((function(r,o){return t(o,r,e)}))}function re(e){var t=e[Ue];return t?t.i>3?t.i-4:t.i:Array.isArray(e)?1:ae(e)?2:ie(e)?3:0}function oe(e,t){return 2===re(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function ne(e,t,r){var o=re(e);2===o?e.set(t,r):3===o?(e.delete(t),e.add(r)):e[t]=r}function ae(e){return Ie&&e instanceof Map}function ie(e){return Ne&&e instanceof Set}function se(e){return e.o||e.t}function ce(e){if(Array.isArray(e))return Array.prototype.slice.call(e);var t=We(e);delete t[Ue];for(var r=ze(t),o=0;o<r.length;o++){var n=r[o],a=t[n];!1===a.writable&&(a.writable=!0,a.configurable=!0),(a.get||a.set)&&(t[n]={configurable:!0,writable:!0,enumerable:a.enumerable,value:e[n]})}return Object.create(Object.getPrototypeOf(e),t)}function ue(e,t){return void 0===t&&(t=!1),fe(e)||Z(e)||!ee(e)||(re(e)>1&&(e.set=e.add=e.clear=e.delete=de),Object.freeze(e),t&&te(e,(function(e,t){return ue(t,!0)}),!0)),e}function de(){Y(2)}function fe(e){return null==e||"object"!=typeof e||Object.isFrozen(e)}function le(e){var t=$e[e];return t||Y(18,e),t}function pe(){return"production"===process.env.NODE_ENV||xe||Y(0),xe}function ye(e,t){t&&(le("Patches"),e.u=[],e.s=[],e.v=t)}function me(e){he(e),e.p.forEach(ve),e.p=null}function he(e){e===xe&&(xe=e.l)}function be(e){return xe={p:[],l:xe,h:e,m:!0,_:0}}function ve(e){var t=e[Ue];0===t.i||1===t.i?t.j():t.g=!0}function ge(e,t){t._=t.p.length;var r=t.p[0],o=void 0!==e&&e!==r;return t.h.O||le("ES5").S(t,e,o),o?(r[Ue].P&&(me(t),Y(4)),ee(e)&&(e=we(t,e),t.l||Ee(t,e)),t.u&&le("Patches").M(r[Ue],e,t.u,t.s)):e=we(t,r,[]),me(t),t.u&&t.v(t.u,t.s),e!==Me?e:void 0}function we(e,t,r){if(fe(t))return t;var o=t[Ue];if(!o)return te(t,(function(n,a){return Se(e,o,t,n,a,r)}),!0),t;if(o.A!==e)return t;if(!o.P)return Ee(e,o.t,!0),o.t;if(!o.I){o.I=!0,o.A._--;var n=4===o.i||5===o.i?o.o=ce(o.k):o.o;te(3===o.i?new Set(n):n,(function(t,a){return Se(e,o,n,t,a,r)})),Ee(e,n,!1),r&&e.u&&le("Patches").R(o,r,e.u,e.s)}return o.o}function Se(e,t,r,o,n,a){if("production"!==process.env.NODE_ENV&&n===r&&Y(5),Z(n)){var i=we(e,n,a&&t&&3!==t.i&&!oe(t.D,o)?a.concat(o):void 0);if(ne(r,o,i),!Z(i))return;e.m=!1}if(ee(n)&&!fe(n)){if(!e.h.F&&e._<1)return;we(e,n),t&&t.A.l||Ee(e,n)}}function Ee(e,t,r){void 0===r&&(r=!1),e.h.F&&e.m&&ue(t,r)}function Oe(e,t){var r=e[Ue];return(r?se(r):e)[t]}function Re(e,t){if(t in e)for(var r=Object.getPrototypeOf(e);r;){var o=Object.getOwnPropertyDescriptor(r,t);if(o)return o;r=Object.getPrototypeOf(r)}}function je(e){e.P||(e.P=!0,e.l&&je(e.l))}function Pe(e){e.o||(e.o=ce(e.t))}function Te(e,t,r){var o=ae(t)?le("MapSet").N(t,r):ie(t)?le("MapSet").T(t,r):e.O?function(e,t){var r=Array.isArray(e),o={i:r?1:0,A:t?t.A:pe(),P:!1,I:!1,D:{},l:t,t:e,k:null,o:null,j:null,C:!1},n=o,a=Ge;r&&(n=[o],a=Ke);var i=Proxy.revocable(n,a),s=i.revoke,c=i.proxy;return o.k=c,o.j=s,c}(t,r):le("ES5").J(t,r);return(r?r.A:pe()).p.push(o),o}function _e(e){return Z(e)||Y(22,e),function e(t){if(!ee(t))return t;var r,o=t[Ue],n=re(t);if(o){if(!o.P&&(o.i<4||!le("ES5").K(o)))return o.t;o.I=!0,r=Ae(t,n),o.I=!1}else r=Ae(t,n);return te(r,(function(t,n){o&&function(e,t){return 2===re(e)?e.get(t):e[t]}(o.t,t)===n||ne(r,t,e(n))})),3===n?new Set(r):r}(e)}function Ae(e,t){switch(t){case 2:return new Map(e);case 3:return Array.from(e)}return ce(e)}var De,xe,Fe="undefined"!=typeof Symbol&&"symbol"==typeof Symbol("x"),Ie="undefined"!=typeof Map,Ne="undefined"!=typeof Set,qe="undefined"!=typeof Proxy&&void 0!==Proxy.revocable&&"undefined"!=typeof Reflect,Me=Fe?Symbol.for("immer-nothing"):((De={})["immer-nothing"]=!0,De),ke=Fe?Symbol.for("immer-draftable"):"__$immer_draftable",Ue=Fe?Symbol.for("immer-state"):"__$immer_state",Ce={0:"Illegal state",1:"Immer drafts cannot have computed properties",2:"This object has been frozen and should not be mutated",3:function(e){return"Cannot use a proxy that has been revoked. Did you pass an object from inside an immer function to an async process? "+e},4:"An immer producer returned a new value *and* modified its draft. Either return a new value *or* modify the draft.",5:"Immer forbids circular references",6:"The first or second argument to `produce` must be a function",7:"The third argument to `produce` must be a function or undefined",8:"First argument to `createDraft` must be a plain object, an array, or an immerable object",9:"First argument to `finishDraft` must be a draft returned by `createDraft`",10:"The given draft is already finalized",11:"Object.defineProperty() cannot be used on an Immer draft",12:"Object.setPrototypeOf() cannot be used on an Immer draft",13:"Immer only supports deleting array indices",14:"Immer only supports setting array indices and the 'length' property",15:function(e){return"Cannot apply patch, path doesn't resolve: "+e},16:'Sets cannot have "replace" patches.',17:function(e){return"Unsupported patch operation: "+e},18:function(e){return"The plugin for '"+e+"' has not been loaded into Immer. To enable the plugin, import and call `enable"+e+"()` when initializing your application."},20:"Cannot use proxies if Proxy, Proxy.revocable or Reflect are not available",21:function(e){return"produce can only be called on things that are draftable: plain objects, arrays, Map, Set or classes that are marked with '[immerable]: true'. Got '"+e+"'"},22:function(e){return"'current' expects a draft, got: "+e},23:function(e){return"'original' expects a draft, got: "+e},24:"Patching reserved attributes like __proto__, prototype and constructor is not allowed"},Ve=""+Object.prototype.constructor,ze="undefined"!=typeof Reflect&&Reflect.ownKeys?Reflect.ownKeys:void 0!==Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames,We=Object.getOwnPropertyDescriptors||function(e){var t={};return ze(e).forEach((function(r){t[r]=Object.getOwnPropertyDescriptor(e,r)})),t},$e={},Ge={get:function(e,t){if(t===Ue)return e;var r=se(e);if(!oe(r,t))return function(e,t,r){var o,n=Re(t,r);return n?"value"in n?n.value:null===(o=n.get)||void 0===o?void 0:o.call(e.k):void 0}(e,r,t);var o=r[t];return e.I||!ee(o)?o:o===Oe(e.t,t)?(Pe(e),e.o[t]=Te(e.A.h,o,e)):o},has:function(e,t){return t in se(e)},ownKeys:function(e){return Reflect.ownKeys(se(e))},set:function(e,t,r){var o=Re(se(e),t);if(null==o?void 0:o.set)return o.set.call(e.k,r),!0;if(!e.P){var n=Oe(se(e),t),a=null==n?void 0:n[Ue];if(a&&a.t===r)return e.o[t]=r,e.D[t]=!1,!0;if(function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}(r,n)&&(void 0!==r||oe(e.t,t)))return!0;Pe(e),je(e)}return e.o[t]===r&&"number"!=typeof r||(e.o[t]=r,e.D[t]=!0,!0)},deleteProperty:function(e,t){return void 0!==Oe(e.t,t)||t in e.t?(e.D[t]=!1,Pe(e),je(e)):delete e.D[t],e.o&&delete e.o[t],!0},getOwnPropertyDescriptor:function(e,t){var r=se(e),o=Reflect.getOwnPropertyDescriptor(r,t);return o?{writable:!0,configurable:1!==e.i||"length"!==t,enumerable:o.enumerable,value:r[t]}:o},defineProperty:function(){Y(11)},getPrototypeOf:function(e){return Object.getPrototypeOf(e.t)},setPrototypeOf:function(){Y(12)}},Ke={};te(Ge,(function(e,t){Ke[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}})),Ke.deleteProperty=function(e,t){return"production"!==process.env.NODE_ENV&&isNaN(parseInt(t))&&Y(13),Ge.deleteProperty.call(this,e[0],t)},Ke.set=function(e,t,r){return"production"!==process.env.NODE_ENV&&"length"!==t&&isNaN(parseInt(t))&&Y(14),Ge.set.call(this,e[0],t,r,e[0])};for(var Le,Qe=new(function(){function e(e){var t=this;this.O=qe,this.F=!0,this.produce=function(e,r,o){if("function"==typeof e&&"function"!=typeof r){var n=r;r=e;var a=t;return function(e){var t=this;void 0===e&&(e=n);for(var o=arguments.length,i=Array(o>1?o-1:0),s=1;s<o;s++)i[s-1]=arguments[s];return a.produce(e,(function(e){var o;return(o=r).call.apply(o,[t,e].concat(i))}))}}var i;if("function"!=typeof r&&Y(6),void 0!==o&&"function"!=typeof o&&Y(7),ee(e)){var s=be(t),c=Te(t,e,void 0),u=!0;try{i=r(c),u=!1}finally{u?me(s):he(s)}return"undefined"!=typeof Promise&&i instanceof Promise?i.then((function(e){return ye(s,o),ge(e,s)}),(function(e){throw me(s),e})):(ye(s,o),ge(i,s))}if(!e||"object"!=typeof e){if((i=r(e))===Me)return;return void 0===i&&(i=e),t.F&&ue(i,!0),i}Y(21,e)},this.produceWithPatches=function(e,r){return"function"==typeof e?function(r){for(var o=arguments.length,n=Array(o>1?o-1:0),a=1;a<o;a++)n[a-1]=arguments[a];return t.produceWithPatches(r,(function(t){return e.apply(void 0,[t].concat(n))}))}:[t.produce(e,r,(function(e,t){o=e,n=t})),o,n];var o,n},"boolean"==typeof(null==e?void 0:e.useProxies)&&this.setUseProxies(e.useProxies),"boolean"==typeof(null==e?void 0:e.autoFreeze)&&this.setAutoFreeze(e.autoFreeze)}var t=e.prototype;return t.createDraft=function(e){ee(e)||Y(8),Z(e)&&(e=_e(e));var t=be(this),r=Te(this,e,void 0);return r[Ue].C=!0,he(t),r},t.finishDraft=function(e,t){var r=e&&e[Ue];"production"!==process.env.NODE_ENV&&(r&&r.C||Y(9),r.I&&Y(10));var o=r.A;return ye(o,t),ge(void 0,o)},t.setAutoFreeze=function(e){this.F=e},t.setUseProxies=function(e){e&&!qe&&Y(20),this.O=e},t.applyPatches=function(e,t){var r;for(r=t.length-1;r>=0;r--){var o=t[r];if(0===o.path.length&&"replace"===o.op){e=o.value;break}}var n=le("Patches").$;return Z(e)?n(e,t):this.produce(e,(function(e){return n(e,t.slice(r+1))}))},e}()),Be=Qe.produce,He=(Qe.produceWithPatches.bind(Qe),Qe.setAutoFreeze.bind(Qe),Qe.setUseProxies.bind(Qe),Qe.applyPatches.bind(Qe),Qe.createDraft.bind(Qe),Qe.finishDraft.bind(Qe),256),Je=[];He--;)Je[He]=(He+256).toString(16).substring(1);function Xe(){var e,t=0,r="";if(!Le||He+16>256){for(Le=Array(t=256);t--;)Le[t]=256*Math.random()|0;t=He=0}for(;t<16;t++)e=Le[He+t],r+=6==t?Je[15&e|64]:8==t?Je[63&e|128]:Je[e],1&t&&t>1&&t<11&&(r+="-");return He++,r}var Ye=function(e){return e};const Ze=Symbol("record-state-new"),et=Symbol("record-state-saving"),tt=Symbol("record-state-updating"),rt=Symbol("record-state-getting"),ot=Symbol("record-state-persisted"),nt=Symbol("record-state-deleting"),at=Symbol("record-state-deleted"),it=Symbol("request-status-new"),st=Symbol("request-status-working"),ct=Symbol("request-status-error"),ut=Symbol("request-status-finished"),dt=Symbol("request-status-timeout"),ft=Symbol("action-new-record"),lt=Symbol("action-new-request");var pt=Object.freeze({__proto__:null,RECORD_STATE_NEW:Ze,RECORD_STATE_SAVING:et,RECORD_STATE_UPDATING:tt,RECORD_STATE_GETTING:rt,RECORD_STATE_PERSISTED:ot,RECORD_STATE_DELETING:nt,RECORD_STATE_DELETED:at,REQUEST_STATUS_NEW:it,REQUEST_STATUS_WORKING:st,REQUEST_STATUS_ERROR:ct,REQUEST_STATUS_FINISHED:ut,REQUEST_STATUS_TIMEOUT:dt,ACTION_NEW_RECORD:ft,ACTION_NEW_REQUEST:lt});class yt{constructor(e){const{identity:t,props:r,meta:o={},status:n=Ze,store:a,tag:i}=e;this.identity=t,this.props=r,this.meta=o,this.status=n,this.store=a,this.tag=i||Xe(),this[ke]=!0}get pure(){return{identity:this.identity,props:this.props,status:this.status,meta:this.meta,store:this.store}}}var mt=(t,r={},o=Ze,n={},a)=>{o===e["Å"]&&(o=Ze),n===e["Å"]&&(n={});const i=Xe();try{return Be(new yt({identity:t,status:o,props:r,meta:n,tag:i,store:a}),Ye)}catch(e){return console.log(e.message,"--- cannot immerize this data:",t,r,o,n,i),new yt({identity:t,status:o,props:r,meta:n,tag:i,store:a})}},ht=(t,r,o="",n={})=>{const a=Xe(),i=new e.ValueObjectStream({action:t,params:r,store:o,name:a,out:null,status:it,options:n},{name:a,actions:{isOpen:e=>[it,st].includes(e.my.status),work(e){if(e.my.status===it)return e.do.setStatus(st);throw console.warn("attempt to work a request that is status ",e.my.status),new Error("cannot work this request")},finish(t,r=e["Å"]){if(t.do.isOpen()){const e=t.trans(-1);t.do.setOut(r),t.do.setStatus(ut),e.complete()}else console.warn("!!!!!!!!! attempt to finish a non-opened request",t)},fail(t,r=e["Å"]){if(t.do.isOpen()){const o=t.trans(-1);r!==e["Å"]&&t.do.setOut(r),t.do.setStatus(ct),o.complete()}else console.warn("attempt to fails a non-opened request",t)},expire(e){[it,st].includes(e.my.status)&&e.do.setStatus(dt)}}});return i.onField((e,t)=>{const{status:r}=e.value;if(r!==t.my.status)switch(t.my.status){case it:break;case st:if(![dt,ut,ct].includes(r))throw new Error(`cannot transition to ${r.toString()} from ${t.my.status.toString()}`);break;case dt:throw new Error("cannot change status from Timeout");case ut:throw new Error("cannot change status from Finished")}else 1===[...Object.keys(e.value)].length&&e.complete()},"status"),n.time&&setTimeout(i.do.expire,n.time),i},bt=(t,r={},o=!1)=>{const n=e.addActions(new e.ValueMapStream({schema:r,transport:o,name:t,records:new Map,requests:new Map},{name:t}),{request(e,t,r,o){const n=ht(t,r,e.name,o);return e.fields.requests.set(n.name,n),e.send(lt,n),n},onRequest:(t,r)=>t.on(e=>{r(e.value)},lt,e.E_COMPLETE),getRequest:(e,t)=>e.my.requests.has(t)?e.my.requests.get(t):e.do.hasRequestStream(t)?e.fields.requests.get(t):null,hasRequestStream:(e,t)=>e.fields.requests.has(t),getRequestStream:(e,r)=>e.fields.requests.has(r)?e.fields.requests.fieldSubjects.get(r):t.name?e.do.getRequestStream(r.name):null,upsertRecord:(e,t,...r)=>e.do.hasRecord(t)?e.do.updateRecordProps(t,...r):e.do.createRecord(e,t,...r),createRecord(t,r,o,n,a){if(t.do.hasRecord(r))return console.warn("createRecord record -- ",r,"exists"),t.do.updateRecordProps(r,o);const i=mt(r,o,n,a,t.name),s=t.send(ft,i,[e.E_FILTER]);return s.thrownError?(console.warn("createRecord error:",s.thrownError),s):t.fields.records.set(r,s.value)},setRecord:(e,t,r,o)=>"object"!=typeof t||r?o?e.records.set(t,r):e.fields.records.set(t,new yt({...r,identity:t})):e.do.setRecord(t.identity,t),createRecords(e,t){const r=e.fields.records.trans(0);try{t instanceof Map?(t.forEach((t,r)=>{e.do.createRecord(r,t)}),r.complete()):Array.isArray(t)&&t.forEach(t=>{if(!("identity"in t))throw new Error("each record must have an identity field");if(!("props"in t))throw new Error("each record must have an identity field");e.do.setRecord(t)})}catch(e){throw r.error(e),e}},updateRecord(e,t,r){if("function"==typeof r)return e.do.mutateRecord(t,r);if(!e.do.hasRecord(t))throw new Error("update: no existing record "+t);return e.do.mutateRecord(t,e=>Be(e,e=>new yt({...e,...r,identity:t})))},updateRecordProps(e,t,r,o){if(!e.do.hasRecord(t))throw new Error("update: no existing record "+t);return e.do.mutateRecord(t,e=>Be(e,e=>{"function"==typeof r?e.props=r(e.props,e,n):"object"==typeof r&&(e.props=o?{...r}:{...e.props,...r})}))},updateRecordMeta:(e,t,r,o)=>e.do.updateRecordMetas(t,r,o),updateRecordMetas(t,r,o,n=e["Å"]){if(!t.do.hasRecord(r))throw new Error("update: no existing record "+r);return t.do.mutateRecord(r,t=>Be(t,t=>{"object"==typeof o?t.meta={...t.meta,...o}:"string"==typeof o&&n!==e["Å"]&&(t.meta[o]=n)}))},updateRecordStatus(e,t,r){if(!e.do.hasRecord(t))throw new Error("update: no existing record "+t);return e.do.mutateRecord(t,e=>Be(e,e=>{e.status=r}))},mutateRecord(e,t,r){if("function"!=typeof r)throw new Error("mutateRecord - passed non functional mutator");if(!e.do.hasRecord(t))throw new Error("update: no existing record "+t);let o=e.do.record(t);try{o=Be(o,r)}catch(t){throw console.log("mutation error: ",o,"mutator:",r.toString(),"subject: ",e),t}return e.fields.records.set(t,o)},hasRecord:(e,t)=>e.my.records.has(t),removeRecord(e,t){const r=e.do.record(t);return r?(e.my.records.delete(t),r):null},record:(e,t)=>e.my.records.get(t),r:(e,t)=>e.do.record(t),onNewRecord(t,r){if("function"!=typeof r)throw new Error(`store ${t.name}requires functional handler for onNewRecord`);const o=new Set;function n(e,n){if(!o.has(e.tag)){o.add(e.tag);const a=r(e,n,t);return a&&e!==a&&n.next(a),!0}return!1}t.on(e=>{n(e.value,e)},ft,e.E_FILTER),t.fields.records&&t.fields.records.onField(e=>{e.value.forEach(t=>{if(!e.isStopped)try{n(t,e)}catch(t){e.isStopped||e.error(t)}})},()=>!0)}}),a=new e.ValueMapStream({},{name:n.name+"-records"});return n.addFieldSubject("records",a),n.addFieldSubject("requests",new e.ValueMapStream({})),n.fields.records.on(e=>{const t=e.value;t.forEach((e,r)=>{e instanceof yt||(e.identity=r,t.set(r,new yt(e)))})},e.A_SET,e.E_INITIAL),n.do.onNewRecord(e=>Be(e,t=>{t.meta.originalProps={...e.props}})),n};return{...pt,requestFactory:ht,storeFactory:bt,recordFactory:mt,baseFactory:(t,r)=>{const o=new e.ValueMapStream({name:t,stores:new Map,transport:r,views:new Map},{name:t,actions:{addStore(e,t,...r){e.fields.stores.set(t,bt(t,...r))},store:(e,t)=>(console.log("structure: ",e.object),e.my.stores.get(t)),createRecord:(e,t,...r)=>(console.log("creating record",r,"in",t),e.my.stores.get(t).do.createRecord(...r)),r:(e,t,...r)=>e.my.stores.get(t).do.r(...r),request:(e,t,...r)=>e.my.stores.get(t).do.request(...r),onRequest:(e,t,...r)=>e.my.stores.get(t).do.onRequest(...r)}});return o.addFieldSubject("stores",new e.ValueMapStreamFast({})),o.addFieldSubject("views",new e.ValueMapStreamFast({})),o},produce:Be}}));
